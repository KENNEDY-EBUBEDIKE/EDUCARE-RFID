<!doctype html>
<html lang="en">
{% load static %}
{% csrf_token %}
<head>
        <title>Winexviv| Scan Profile</title>
        <!-- Required meta tags -->
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="description" content="Maha Personal cv/resume template for professional and personal website." />
        <meta name="keywords" content="creative, cv, designer,  online cv, online resume, powerful portfolio, professional, professional resume, responsive, resume, vcard " />
        <meta name="developer" content="Md. Siful Islam">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

        <!-- FAV AND ICONS   -->
        <link rel="shortcut icon" href="{% static 'scan-profile/assets/images/favicon.ico' %}">
        <link rel="shortcut icon" href="{% static 'scan-profile/assets/images/apple-icon.png' %}">
        <link rel="shortcut icon" sizes="72x72" href="{% static 'scan-profile/assets/images/apple-icon-72x72.png' %}">
        <link rel="shortcut icon" sizes="114x114" href="{% static 'scan-profile/assets/images/apple-icon-114x114.png' %}">

        <!-- Google Font-->
<!--        <link href="http://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">-->
        <!-- Font Awesome -->
        <link rel="stylesheet" href="{% static 'scan-profile/assets/icons/font-awesome-4.7.0/css/font-awesome.min.css' %}">
        <!-- Bootstrap CSS -->
        <link rel="stylesheet" href="{% static 'scan-profile/assets/plugins/css/bootstrap.min.css' %}">
        <!-- Animate CSS-->
        <link rel="stylesheet" href="{% static 'scan-profile/assets/plugins/css/animate.css' %}">
        <!-- Owl Carousel CSS-->
        <link rel="stylesheet" href="{% static 'scan-profile/assets/plugins/css/owl.css' %}">
        <!-- Fancybox-->
        <link rel="stylesheet" href="{% static 'scan-profile/assets/plugins/css/jquery.fancybox.min.css' %}">
        <!-- Custom CSS-->
        <link rel="stylesheet" href="{% static 'scan-profile/assets/css/styles.css' %}">
        <link rel="stylesheet" href="{% static 'scan-profile/assets/css/responsive.css' %}">

            <!-- Sweet Alert -->
      <link rel="stylesheet" href="{% static 'dist/css/sweetalert2.min.css' %}">
        <!-- Animate style -->
      <link rel="stylesheet" href="{% static 'dist/css/animate.min.css' %}">

        <!-- Colors -->
        <link rel="alternate stylesheet" href="{% static 'scan-profile/assets/css/colors/blue.css' %}" title="blue">
        <link rel="stylesheet" href="{% static 'scan-profile/assets/css/colors/defauld.css' %}" title="defauld">
        <link rel="alternate stylesheet" href="{% static 'scan-profile/assets/css/colors/green.css' %}" title="green">
        <link rel="alternate stylesheet" href="{% static 'scan-profile/assets/css/colors/blue-munsell.css' %}" title="blue-munsell">
        <link rel="alternate stylesheet" href="{% static 'scan-profile/assets/css/colors/orange.css' %}" title="orange">
        <link rel="alternate stylesheet" href="{% static 'scan-profile/assets/css/colors/purple.css' %}" title="purple">
        <link rel="alternate stylesheet" href="{% static 'scan-profile/assets/css/colors/slate.css' %}" title="slate">
        <link rel="alternate stylesheet" href="{% static 'scan-profile/assets/css/colors/yellow.css' %}" title="yellow">
    </head>
    <body class="dark-vertion black-bg">
        <!-- Start Loader -->
        <div class="section-loader">
            <div class="loader">
                <div></div>
                <div></div>
            </div>
        </div>
        <!-- End Loader -->

        <!--
        ===================
           NAVIGATION
        ===================
        -->
        <header class="black-bg mh-header mh-fixed-nav nav-scroll mh-xs-mobile-nav wow fadeInUp" id="mh-header">
            <div class="overlay"></div>
            <div class="container">
                <div class="row">
                    <nav class="navbar navbar-expand-lg mh-nav nav-btn">
                        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                            <span class="navbar-toggler-icon icon"></span>
                        </button>

                        <div class="collapse navbar-collapse" id="navbarSupportedContent">
                            <ul class="navbar-nav mr-auto ml-auto">
                                <li class="nav-item">
                                    <a class="nav-link" href="{% url 'students_list' %}">Home</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" onclick="start()" href="#">Start Scan</a>
                                </li>
                            </ul>
                        </div>
                    </nav>
                </div>
            </div>
        </header>

        <!--
        ===================
            HOME
        ===================
        -->
        <section class="mh-home" id="mh-home">
            <div class="home-ovimg">
                <div class="container">
                    <div class="row xs-column-reverse section-separator vertical-middle-content home-padding">
                        <div class="col-sm-6">
                            <div class="mh-header-info">
                                <div class="mh-promo wow fadeInUp" data-wow-duration="0.8s" data-wow-delay="0.1s">
                                    <span>Hello I'm</span>
                                </div>

                                <h2 class="wow fadeInUp" data-wow-duration="0.8s" data-wow-delay="0.2s" id="name">SCAN</h2>
                                <h4 class="wow fadeInUp" data-wow-duration="0.8s" data-wow-delay="0.3s" id="appointment">SCAN</h4>

                                <ul>
                                    <li class="wow fadeInUp" data-wow-duration="0.8s" data-wow-delay="0.6s"><i class="fa fa-map-marker"></i><address id="class" >SCAN</address></li>
                                </ul>

                                <ul class="social-icon wow fadeInUp" data-wow-duration="0.8s" data-wow-delay="0.7s">
                                    <li><a href="#"><i class="fa fa-facebook"></i></a></li>
                                    <li><a href="#"><i class="fa fa-twitter"></i></a></li>
                                    <li><a href="#"><i class="fa fa-github"></i></a></li>
                                    <li><a href="#"><i class="fa fa-dribbble"></i></a></li>
                                </ul>
                            </div>
                        </div>
                        <div class="col-sm-6">
                            <div class="hero-img wow fadeInUp" data-wow-duration="0.8s" data-wow-delay="0.6s">
                                <img id="photo" src="{% static 'scan-profile/assets/images/hero.png' %}" class="img-fluid">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

    <!--
    ==============
    * JS Files *
    ==============
    -->

    <!-- jQuery first, then Popper.js, then Bootstrap JS -->

    <!-- jQuery -->
    <script src="{% static 'scan-profile/assets/plugins/js/jquery.min.js' %}"></script>
    <!-- popper -->
    <script src="{% static 'scan-profile/assets/plugins/js/popper.min.js' %}"></script>
    <!-- bootstrap -->
    <script src="{% static 'scan-profile/assets/plugins/js/bootstrap.min.js' %}"></script>
        <!-- sweet Alert-->
    <script src="{% static 'dist/js/sweetalert2.min.js' %}"></script>
    <!-- owl carousel -->
    <script src="{% static 'scan-profile/assets/plugins/js/owl.carousel.js' %}"></script>
    <!-- validator -->
    <script src="{% static 'scan-profile/assets/plugins/js/validator.min.js' %}"></script>
    <!-- wow -->
    <script src="{% static 'scan-profile/assets/plugins/js/wow.min.js' %}"></script>
    <!-- mixin js-->
    <script src="{% static 'scan-profile/assets/plugins/js/jquery.mixitup.min.js' %}"></script>
    <!-- circle progress-->
    <script src="{% static 'scan-profile/assets/plugins/js/circle-progress.js' %}"></script>
    <!-- jquery nav -->
    <script src="{% static 'scan-profile/assets/plugins/js/jquery.nav.js' %}"></script>
    <!-- Fancybox js-->
    <script src="{% static 'scan-profile/assets/plugins/js/jquery.fancybox.min.js' %}"></script>
    <!-- isotope js-->
    <script src="{% static 'scan-profile/assets/plugins/js/isotope.pkgd.js' %}"></script>
    <script src="{% static 'scan-profile/assets/plugins/js/packery-mode.pkgd.js' %}"></script>
    <!-- Map api -->
    <script src="http://maps.googleapis.com/maps/api/js?v=3.exp&amp;key=AIzaSyCRP2E3BhaVKYs7BvNytBNumU0MBmjhhxc"></script>
    <!-- Custom Scripts-->
    <script src="{% static 'scan-profile/assets/js/map-init.js' %}"></script>
    <script src="{% static 'scan-profile/assets/js/custom-scripts.js' %}"></script>


    <!-- ****************
      After neccessary customization/modification, Please minify
      JavaScript/jQuery according to http://browserdiet.com/en/ for better performance
    **************** -->
    <!-- STYLE SWITCH STYLESHEET ONLY FOR DEMO -->
    <link rel="stylesheet" href="{% static 'scan-profile/demo/demo.css' %}">
    <script type="text/javascript" src="{% static 'scan-profile/demo/styleswitcher.js' %}"></script>
    <script type="text/javascript" src="{% static 'scan-profile/demo/demo.js' %}"></script>
        <div class="demo-style-switch" id="switch-style">
<!--    <a id="toggle-switcher" class="switch-button"><i class="fa fa-snowflake-o fa-spin"></i></a>-->
    <div class="switched-options">

    <div class="config-title">
        Colors :
    </div>
    <ul class="styles">
        <li><a href="#" onclick="setActiveStyleSheet('blue'); return false;" title="Blue">
            <div class="blue"></div></a>
        </li>
        <li><a href="#" onclick="setActiveStyleSheet('purple'); return false;" title="Purple">
            <div class="purple"></div></a>
        </li>
        <li><a href="#" onclick="setActiveStyleSheet('blue-munsell'); return false;" title="Blue Munsell">
            <div class="blue-munsell"></div></a>
        </li>
        <li><a href="#" onclick="setActiveStyleSheet('orange'); return false;" title="Orange">
            <div class="orange"></div></a>
        </li>
        <li><a href="#" onclick="setActiveStyleSheet('slate'); return false;" title="Slate">
            <div class="slate"></div></a>
        </li>
        <li><a href="#" onclick="setActiveStyleSheet('green'); return false;" title="Green">
            <div class="green"></div></a>
        </li>
        <li><a href="#" onclick="setActiveStyleSheet('yellow'); return false;" title="Yellow">
            <div class="yellow"></div></a>
        </li>
        <li><a href="#" onclick="setActiveStyleSheet('red'); return false;" title="Red">
            <div class="red"></div></a>
        </li>
    </ul>
    </div>
    </div>
    <script>
        const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    </script>
    <script>
      function start(){
        event.preventDefault()
        connectSerial()
        let port, textEncoder, writableStreamClosed, writer;

        async function connectSerial() {
            try {
                // Prompt user to select any serial port.
                port = await navigator.serial.requestPort();
                await port.open({ baudRate: "9600" });
                listenToPort();

                textEncoder = new TextEncoderStream();
                writableStreamClosed = textEncoder.readable.pipeTo(port.writable);

                writer = textEncoder.writable.getWriter();
            } catch (e){
                alert(e + "Serial Connection Failed");
            }
        }
        let v = "";
        async function listenToPort() {
            const textDecoder = new TextDecoderStream();
            const readableStreamClosed = port.readable.pipeTo(textDecoder.writable);
            const reader = textDecoder.readable.getReader();

            // Listen to data coming from the serial device.
            while (true) {
                let { value, done } = await reader.read();
                if (done) {
                    // Allow the serial port to be closed later.
                    // reader.releaseLock();
                    break;
                }
                // value is a string.
                let newLine = /\r\n|\r|\n/.exec(value);

                if (newLine){
                    v += value;
                    v.replace(/\r\n|\n|\r|\s/g, "")
                    if (!v.replace(/\r\n|\n|\r|\s/g, "").length) {
                      console.log("string only contains whitespace (ie. spaces, tabs or line breaks)");
                    }else {
                        if (v.length > 3){
                            makeRequest(v)
                        }
                    }
                    v = "";
                }else{
                    v += value;
                }
            }
        }

        async function sendSerialLine(data) {
            await writer.write(data);
            //await writer.releaseLock();
        }

        function makeRequest(value){
            $.ajax({
                url: "/api/students/scan-student/",
                type: 'POST',
                data: {"code": value,},
                dataType: "json",
                headers: {'X-CSRFToken': csrftoken},
                mode: 'same-origin',
                success: function (response){

                    if (response.success){
                        document.getElementById("name").textContent = `${response.student.first_name}  ${response.student.surname}`
                        document.getElementById("class").textContent = response.student.classs
                        document.getElementById("appointment").textContent = "Student"
                        document.getElementById("photo").src = response.student.photo
                        sendSerialLine(1)

                    } else if (!response.success){
                        document.getElementById("name").textContent = "Card Does Not Exist"
                        document.getElementById("class").textContent = "Card Does Not Exist"
                        document.getElementById("appointment").textContent = "Card Does Not Exist"
                        document.getElementById("photo").src = "/media/image/avatar.png"
                        sendSerialLine(2)
                    }
                    v = ""
                },
            })
        }
      }
    </script>
</body>

</html>
